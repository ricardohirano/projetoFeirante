<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agendar Feiras - Passo 3 (Preview)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div>
        <main>
            <h1>Pré-visualização da sua Vitrine</h1>
            <p>
              É assim que a sua "barraca" irá aparecer para os clientes
              na vitrine online para esta feira.
            </p>

            <!-- 1. O Layout da Barraca (Preview) -->
            <div style="border: 2px solid #007bff; border-radius: 8px; padding: 20px; margin: 20px 0;">
                
                <h2>{{ usuario.get('nome_fantasia', 'Minha Barraca') }}</h2>
                
                <hr>
                
                <h4>Dados do Feirante:</h4>
                <p><b>Telefone:</b> {{ usuario.get('telefone', '(Não cadastrado)') }}</p>
                <p><b>Bio:</b> {{ usuario.get('bio', '(Sem biografia)') }}</p>
                
                <hr>
                
                <h4>Feira Selecionada:</h4>
                <p><b>Nome:</b> {{ feira.nome }}</p>
                <p><b>Data:</b> {{ data }}</p>
                <p><b>Horário:</b> {{ feira.horario }}</p>
                <p><b>Local:</b> {{ feira.endereco }}</p>
                
                {% if feira.mapa_embed_url %}
                    <iframe 
                      src="{{ feira.mapa_embed_url }}" 
                      width="100%" 
                      height="300" 
                      style="border:0;" 
                      allowfullscreen="" 
                      loading="lazy" 
                      referrerpolicy="no-referrer-when-downgrade"
                    ></iframe>
                {% endif %}

                <hr>

                <!-- 
                  *** CORREÇÃO AQUI ***
                  (Agora usa o loop-duplo com 'produtos_agrupados')
                -->
                <h3>Produtos Disponíveis nesta data:</h3>
                
                {% for categoria, lista_de_produtos in produtos_agrupados.items() %}
                    <h2 style="text-transform: capitalize;">{{ categoria }}</h2>
                    <div class="container-produtos">
                        {% for p in lista_de_produtos %}
                            <div class="card-produto">
                                <img 
                                  src="{{ p.get('imagem_url', 'https://placehold.co/150x100/eeeeee/cccccc?text=Sem+Foto') }}" 
                                  alt="{{ p.nome }}"
                                >
                                <h4>{{ p.nome }}</h4>
                                <p>{{ p.unidade }} R$ {{ p.preco }}</p>
                            </div>
                        {% endfor %}
                    </div>
                    <hr>
                {% else %}
                    <p>Você não selecionou nenhum produto.</p>
                {% endfor %}
                <!-- Fim da correção -->

            </div>
            
            <!-- 2. Botões de Ação -->

            <form 
              action="{{ url_for('feira.salvar_agendamento_final') }}" 
              method="POST" 
              style="display: inline;"
            >
                <button type="submit">
                    Confirmar (Enviar para Moderação)
                </button>
            </form>

            <form 
              action="{{ url_for('feira.cancelar_agendamento_final') }}" 
              method="POST" 
              style="display: inline;"
            >
                <button 
                  type="submit"
                  onclick="return confirm('Tem certeza que deseja cancelar este agendamento?');"
                >
                    Cancelar
                </button>
            </form>

        </main>
    </div>
</body>
</html>